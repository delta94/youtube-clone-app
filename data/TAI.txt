##########################
##5 JOIN 2 TABLES

##1/ IN RA TEN TAT CA TAC GIA VA TONG SO BINH LUAN CUA CAC BAI VIET DUOC VIET BOI MOI TAC GIA
SELECT BV.TEN_TAC_GIA, COUNT(*) TONG_SO_BINH_LUAN
FROM (BAI_VIET BV INNER JOIN BINH_LUAN BL
        ON BV.ID_BV = BL.ID_BV)
GROUP BY BV.ID_BV;

#2/ IN RA TIEU DE TAT CA BAI VIET THUOC CHU DE 'Giao thong'
SELECT BV.TIEU_DE
FROM (BAI_VIET BV NATURAL JOIN CHU_DE CD)
WHERE CD.TEN_CD = 'Giao thong';

#3/ IN RA TEN TAT CA THANH VIEN GIA DINH CUA TAI KHOAN CO SO CMND LA 'CMND'
SELECT TVGD.TEN TEN_TVGD
FROM (ACCINFO AI INNER JOIN THANH_VIEN_GIA_DINH TVGD
        ON AI.ID = TVGD.ID)
WHERE AI.CMND = 'CMND';

#4/ IN RA TEN DANG NHAP VA NGAY GIA NHAP CUA TAT CA TAI KHOAN CO QUOC GIA LA 'Vietnam' VA SAP XEP GIAM DAN THEO THOI DIEM GIA NHAP
SELECT TK.TEN_DANG_NHAP, TK.NGAY_GIA_NHAP
FROM (DIA_CHI DC LEFT OUTER JOIN TAI_KHOAN TK
        ON TK.ID = DC.ID)
WHERE DC.QUOC_GIA = 'Vietnam'
ORDER BY TK.NGAY_GIA_NHAP DESC;

#5/ TINH SO BAI VIET TRUNG BINH CUA MOT CHU DE
SELECT AVG(MYTABLE.SO_BAI_VIET) SO_BAI_VIET_TB
FROM
	(SELECT COUNT(*) SO_BAI_VIET
	FROM (CHU_DE CD RIGHT OUTER JOIN BAI_VIET BV
			ON CD.ID_TT = BV.ID_TT)
	GROUP BY CD.ID_TT) MYTABLE;

#########################
#5 JOIN 3+ TABLES

#1/ IN RA TIEU DE CUA TAT CA CAC BAI VIET DUOC LUU BOI TAI KHOAN CO TEN DANG NHAP LA 'TDN'
SELECT B.TIEU_DE
FROM ((BAI_VIET B NATURAL JOIN LUU_BV LBV)
    NATURAL JOIN TAI_KHOAN TK)
WHERE TK.TEN_DANG_NHAP = 'TDN';

#2/ XIN LINK TAT CA CAC VIDEO CUA TAT CA BAI VIET THUOC CHU DE 'Bong da' CO LUOT QUAN TAM >= 2
SELECT V.LINK
FROM VIDEO V NATURAL JOIN GOM_VIDEO NATURAL JOIN BAI_VIET BV NATURAL JOIN CHU_DE CD
WHERE CD.TEN_CD = 'Bong da'
AND BV.LUOT_QUAN_TAM >= 2;

#3/ VOI CAC TAI KHOAN CO NGAY GIA NHAP SAU '01-01-2000', IN RA NOI DUNG CAC BINH LUAN, TIEU DE CAC BAI VIET CHUA CAC BINH LUAN VA TEN DANG NHAP CAC TAI KHOAN VIET CAC BINH LUAN DO
SELECT BL.NOI_DUNG, BV.TIEU_DE, TK.TEN_DANG_NHAP
FROM TAI_KHOAN TK, CHU_DE CD, BAI_VIET BV, VIET_BL VBL, BINH_LUAN BL
WHERE TK.ID = VBL.ID
AND BL.ID_BL = VBL.ID_BL
AND BL.ID_BV = BV.ID_BV
AND BV.ID_TT = CD.ID_TT
AND TK.NGAY_GIA_NHAP >= '01-01-2000';

#4/ VOI TAI KHOAN CO TEN DANG NHAP 'TDN', IN RA TEN TAT CA TVGD VA SO LAN DO BMI CUA TUNG NGUOI
SELECT TVGD.TEN TEN_TVGD, COUNT(*) SO_LAN_DO_BMI
FROM ((THANH_VIEN_GIA_DINH TVGD INNER JOIN TAI_KHOAN TK ON TK.ID = TVGD.ID)
    INNER JOIN BMI ON TVGD.ID = BMI.ID)
WHERE TK.TEN_DANG_NHAP = 'TDN'
GROUP BY TVGD.TEN;

#5/ LAY TEN, NGAY SINH, LINK AVATAR VA SO DIEN THOAI CUA TAT CA CAC TAI KHOAN CO THONG TIN GIOI TINH LA 'NU' VA QUOC GIA LA 'VIETNAM'
SELECT AI.TEN, AI.NGAY_SINH, TK.LINK_AVATAR, LH.DTHOAI
FROM (((ACCINFO AI INNER JOIN TAI_KHOAN TK ON TK.ID = AI.ID)
    INNER JOIN LIEN_HE LH ON TK.ID = LH.ID)
        INNER JOIN DIA_CHI DC ON TK.ID = DC.ID)
WHERE AI.GT = 'NU'
AND DC.QUOC_GIA = 'VIETNAM';

#########################
#5 NESTED QUERIES

#1/ IN RA SDT CUA CAC TAI KHOAN CO NGAY GIA NHAP LA NGAY HOM NAY
SELECT LH.DTHOAI
FROM LIEN_HE LH
WHERE LH.ID IN
    (SELECT TK.ID
    FROM TAI_KHOAN TK
    WHERE TK.NGAY_GIA_NHAP = NOW());

#2/ IN RA TEN TAC GIA CUA TAT CA BAI VIET DUOC LUU BOI TAI KHOAN CO ID 'ID'
SELECT DISTINCT BV.TEN_TAC_GIA
FROM BAI_VIET BV
WHERE (BV.ID_TT,BV.ID_BV) IN
    (SELECT LBV.ID_TT,LBV.ID_BV
    FROM LUU_BV LBV
    WHERE LBV.ID = 'ID');

#3/ XIN LINK TAT CA ANH CUA BAI VIET CO ID_BV 'bv001' VA ID_TT 'cd001'
SELECT IMG.LINK
FROM IMAGE IMG
WHERE IMG.ID_IMAGE IN
    (SELECT GA.ID_IMAGE
    FROM GOM_ANH GA
    WHERE GA.ID_TT = 'cd001' AND GA.ID_BV = 'bv001');

#4/ VOI TAT CA TAI KHOAN CO THOI GIAN GIA NHAP > 1 NAM, IN RA BMI CUA CAC THANH VIEN GIA DINH CO GIOI TINH LA NU
SELECT *
FROM BMI
WHERE (BMI.ID,BMI.STT) IN
    (SELECT TVGD.ID,TVGD.STT
    FROM THANH_VIEN_GIA_DINH TVGD
    WHERE TVGD.GIOI_TINH = 'NU'
    AND TVGD.ID IN
        (SELECT TK.ID
        FROM TAI_KHOAN TK
        WHERE DATEDIFF(CURRENT_DATE,TK.NGAY_GIA_NHAP) >= 365)
	);

#5/ IN RA DIA CHI CUA (CAC) TAI KHOAN CO SDT '0123456789'
SELECT *
FROM DIA_CHI DC
WHERE DC.ID IN
    (SELECT TK.ID
    FROM (LIEN_HE LH LEFT OUTER JOIN TAI_KHOAN TK
        ON TK.ID = LH.ID)
    WHERE LH.DTHOAI = '0123456789');

#########################
#5 AGGREGATE FUNCTION QUERIES

#1/ TIM CAU TRA LOI CO PHAN TRAM BINH CHON CAO NHAT CUA MOT THAM DO CO ID_TT LA 'ID_TT'
SELECT *
FROM CAU_TRA_LOI CTL1
WHERE CTL1.PHAN_TRAM_CHON IN
    (SELECT MAX(CTL2.PHAN_TRAM_CHON)
    FROM CAU_TRA_LOI CTL2);

#2/ TINH SO BAI VIET TRUC TIEP THUOC MOI CHU DE
SELECT CD.TEN_CD, COUNT(*) SO_BAI_VIET
FROM CHU_DE CD NATURAL JOIN BAI_VIET BV
GROUP BY CD.TEN_CD;

#3/ TINH TONG SO PHIEU BINH CHON CUA THAM DO CO NOI DUNG CAU HOI 'ND'
SELECT SUM(CTL.SO_PHIEU) TONG_SO_PHIEU
FROM CAU_TRA_LOI CTL
WHERE CTL.ID_TT IN
    (SELECT TD.ID_TT
    FROM THAM_DO TD
    WHERE TD.CONTENT = 'ND');

#4/ TINH SO LUONG THANH VIEN GIA DINH TRUNG BINH CUA TAT CA TAI KHOAN
SELECT AVG(MYTABLE.SO_TVGD) SO_TVGD_TB
FROM
    (SELECT COUNT(*) SO_TVGD
    FROM (TAI_KHOAN TK RIGHT OUTER JOIN THANH_VIEN_GIA_DINH TVGD
		ON TK.ID = TVGD.ID)
    GROUP BY TK.ID) MYTABLE;

#5/ IN RA TIEU DE 10 BAI VIET CO NHIEU LUOT THICH NHAT VA SAP XEP THEO THU TU GIAM DAN SO LUOT THICH
SELECT BV.TIEU_DE, COUNT(*) SO_LUOT_THICH
FROM (THICH_BV TBV LEFT OUTER JOIN BAI_VIET BV
		ON TBV.ID_BV = BV.ID_BV
		AND TBV.ID_TT = BV.ID_TT)
GROUP BY BV.ID_TT||''||BV.ID_BV
ORDER BY SO_LUOT_THICH DESC
LIMIT 10;

##########################